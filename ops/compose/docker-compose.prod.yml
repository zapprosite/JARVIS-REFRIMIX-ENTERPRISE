version: "3.8"

services:
  # --- Frontend / Entrypoint ---
  api-gateway:
    build: ../../services/api-gateway
    restart: always
    ports:
      - "3000:3000"
    environment:
      - NODE_ENV=production
      - LOG_LEVEL=info
      - WHATSAPP_ADAPTER_URL=http://whatsapp-adapter:3001
    networks:
      - external
      - internal
    depends_on:
      - whatsapp-adapter
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:3000/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  dashboard:
    build: ../../services/dashboard
    restart: always
    ports:
      - "3002:3002"
    environment:
      - NODE_ENV=production
    networks:
      - external
      - internal
    depends_on:
      - api-gateway

  # --- Adapters ---
  whatsapp-adapter:
    build: ../../services/whatsapp-adapter
    restart: always
    environment:
      - NODE_ENV=production
      - LOG_LEVEL=info
      - ORCHESTRATOR_URL=http://orchestrator-langgraph:8000
      - REDIS_URL=redis://redis:6379
    networks:
      - external
      - internal
    depends_on:
      - redis
      - orchestrator-langgraph
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:3001/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # --- Logic / Orchestration ---
  orchestrator-langgraph:
    build: ../../services/orchestrator-langgraph
    restart: always
    environment:
      - RAG_HVAC_URL=http://rag-hvac:8000
      - BROWSER_TOOLS_URL=http://browser-tools:3000
      - LITELLM_URL=http://litellm:4000
      - REDIS_URL=redis://redis:6379
      - POSTGRES_URL=postgresql://${POSTGRES_USER}:${POSTGRES_PASSWORD}@postgres:5432/${POSTGRES_DB}
    networks:
      - internal
    depends_on:
      - rag-hvac
      - browser-tools
      - litellm
      - postgres
      - redis
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  scheduler:
    build: ../../services/scheduler
    restart: always
    environment:
      - ORCHESTRATOR_URL=http://orchestrator-langgraph:8000
      - HEARTBEAT_INTERVAL_MINUTES=60
    networks:
      - internal
    depends_on:
      - orchestrator-langgraph


  # --- Domain Services ---
  rag-hvac:
    build: ../../services/rag-hvac
    restart: always
    environment:
      - QDRANT_URL=http://qdrant:6333
    networks:
      - internal
    depends_on:
      - qdrant
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  browser-tools:
    build: ../../services/browser-tools
    restart: always
    environment:
      - USER_DATA_DIR=/app/profile
    volumes:
      - browser_profile:/app/profile
    networks:
      - internal
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    # Capabilitites for puppeteer
    cap_add:
      - SYS_ADMIN

  # --- Infra / AI ---
  litellm:
    image: ghcr.io/berriai/litellm:main-latest
    restart: always
    ports:
      - "4000:4000"
    volumes:
      - ../../services/litellm/config.yaml:/app/config.yaml
    command: ["--config", "/app/config.yaml", "--port", "4000"]
    environment:
      - DATABASE_URL=redis://redis:6379
      - REDIS_HOST=redis
      - REDIS_PORT=6379
    networks:
      - internal
    depends_on:
      - redis
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:4000/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # --- Data Structures ---
  qdrant:
    image: qdrant/qdrant:latest
    restart: always
    ports:
      - "6333:6333"
    volumes:
      - ${VOLUME_ROOT:-/nvme}/qdrant:/qdrant/storage
    networks:
      - internal
    healthcheck:
      test: ["CMD-SHELL", "bash -c '</dev/tcp/localhost/6333'"] # Simple tcp check
      interval: 30s
      timeout: 10s
      retries: 3

  postgres:
    image: postgres:15-alpine
    restart: always
    environment:
      - POSTGRES_USER=${POSTGRES_USER}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
      - POSTGRES_DB=${POSTGRES_DB}
    volumes:
      - ${VOLUME_ROOT:-/nvme}/postgres:/var/lib/postgresql/data
      - ../migrations:/migrations:ro
    networks:
      - internal
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U user -d zappro"]
      interval: 10s
      timeout: 5s
      retries: 5

  redis:
    image: redis/redis-stack-server:latest
    restart: always
    volumes:
      - ${VOLUME_ROOT:-/nvme}/redis:/data
    networks:
      - internal
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

networks:
  external:
    driver: bridge
  internal:
    driver: bridge
    internal: true

volumes:
  browser_profile:
